// Event Management Platform - Database Schema
// Prisma ORM Configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum LocationType {
  physical
  virtual
}

enum ApprovalMode {
  automated
  manual
}

enum EventStatus {
  draft
  published
  cancelled
  completed
}

enum RegistrationStatus {
  pending_email
  pending_approval
  confirmed
  rejected
  cancelled
}

enum ApprovalStatus {
  pending
  accepted
  rejected
}

enum NotificationType {
  new_registration
  registration_confirmed
  registration_accepted
  registration_rejected
  event_reminder
  event_updated
  event_cancelled
  system_announcement
}

// ============================================
// MODELS
// ============================================

model User {
  id                  String          @id @default(uuid())
  email               String          @unique
  passwordHash        String          @map("password_hash")
  name                String
  profileImageUrl     String?         @map("profile_image_url")
  bio                 String?
  location            String?
  emailVerified       Boolean         @default(false) @map("email_verified")
  verificationToken   String?         @map("verification_token")
  resetToken          String?         @map("reset_token")
  resetTokenExpires   DateTime?       @map("reset_token_expires")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  isActive            Boolean         @default(true) @map("is_active")
  
  // Relations
  eventsOwned         Event[]         @relation("EventOwner")
  registrations       Registration[]
  notifications       Notification[]
  approvalsGiven      Registration[]  @relation("ApprovedBy")
  
  @@index([email])
  @@index([verificationToken])
  @@index([resetToken])
  @@map("users")
}

model Event {
  id                    String          @id @default(uuid())
  ownerId               String          @map("owner_id")
  title                 String
  description           String          @db.Text
  bannerImageUrl        String?         @map("banner_image_url")
  category              String?
  tags                  String[]
  locationType          LocationType    @map("location_type")
  locationAddress       String?         @db.Text
  locationVirtualLink   String?         @map("location_virtual_link")
  startDatetime         DateTime        @map("start_datetime")
  endDatetime           DateTime        @map("end_datetime")
  timezone              String
  approvalMode          ApprovalMode    @map("approval_mode")
  capacityLimit         Int?            @map("capacity_limit")
  minCapacity           Int?            @map("min_capacity")
  registrationDeadline  DateTime?       @map("registration_deadline")
  status                EventStatus     @default(draft)
  showcaseEnabled       Boolean         @default(false) @map("showcase_enabled")
  showcaseDescription   String?         @db.Text @map("showcase_description")
  showcaseMediaUrls     String[]        @map("showcase_media_urls")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  publishedAt           DateTime?       @map("published_at")
  
  // Relations
  owner                 User            @relation("EventOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  registrations         Registration[]
  notifications         Notification[]
  showcaseLink          ShowcaseLink?
  
  @@index([ownerId])
  @@index([startDatetime])
  @@index([status])
  @@index([category])
  @@map("events")
}

model Registration {
  id                      String              @id @default(uuid())
  eventId                 String              @map("event_id")
  userId                  String              @map("user_id")
  registrationStatus      RegistrationStatus  @default(pending_email) @map("registration_status")
  emailConfirmedAt        DateTime?           @map("email_confirmed_at")
  emailConfirmationToken  String?             @map("email_confirmation_token")
  approvalStatus          ApprovalStatus?     @map("approval_status")
  approvedAt              DateTime?           @map("approved_at")
  approvedById            String?             @map("approved_by_id")
  rejectionReason         String?             @db.Text @map("rejection_reason")
  cancelledAt             DateTime?           @map("cancelled_at")
  calendarInviteSent      Boolean             @default(false) @map("calendar_invite_sent")
  reminderSent24h         Boolean             @default(false) @map("reminder_sent_24h")
  reminderSent1h          Boolean             @default(false) @map("reminder_sent_1h")
  registeredAt            DateTime            @default(now()) @map("registered_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")
  
  // Relations
  event                   Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                    User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedBy              User?               @relation("ApprovedBy", fields: [approvedById], references: [id])
  notifications           Notification[]
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([registrationStatus])
  @@map("registrations")
}

model Notification {
  id                    String            @id @default(uuid())
  userId                String            @map("user_id")
  type                  NotificationType
  title                 String
  message               String            @db.Text
  link                  String?
  relatedEventId        String?           @map("related_event_id")
  relatedRegistrationId String?           @map("related_registration_id")
  isRead                Boolean           @default(false) @map("is_read")
  readAt                DateTime?         @map("read_at")
  createdAt             DateTime          @default(now()) @map("created_at")
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  relatedEvent          Event?            @relation(fields: [relatedEventId], references: [id], onDelete: Cascade)
  relatedRegistration   Registration?     @relation(fields: [relatedRegistrationId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model ShowcaseLink {
  id          String    @id @default(uuid())
  eventId     String    @unique @map("event_id")
  slug        String    @unique
  isPublic    Boolean   @default(true) @map("is_public")
  viewCount   Int       @default(0) @map("view_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@index([slug])
  @@index([eventId])
  @@map("showcase_links")
}
